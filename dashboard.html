<div class="login-container">
  <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
  
  <p id="info"></p>
  <p id="time"></p>

  <button id="startDuty">üö® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
  <button id="endDuty" disabled>‚úÖ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</button>

  <h2>üìú Duty Logs (Realtime)</h2>
  <ul id="logs"></ul>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // üîß config ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const firebaseConfig = {
    apiKey: "AIzaSyATTiyInUWaiPuGVj7DXzd8SLhJOGmbiq4",
    authDomain: "data-service-467404.firebaseapp.com",
    databaseURL: "https://data-service-467404-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "data-service-467404",
    storageBucket: "data-service-467404.appspot.com",
    messagingSenderId: "860747048785",
    appId: "1:860747048785:web:dd47ad5daa9595027dd570",
    measurementId: "G-1X08RZGGEF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
  const name = localStorage.getItem("name");
  const rank = localStorage.getItem("rank");
  const officerId = localStorage.getItem("officerId");
  const loginTime = localStorage.getItem("loginTime");

  if(name && officerId) {
    document.getElementById("info").textContent = `${rank} ${name} | ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${officerId}`;
    document.getElementById("time").textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${loginTime}`;
  }

  const logsEl = document.getElementById("logs");
  const startBtn = document.getElementById("startDuty");
  const endBtn = document.getElementById("endDuty");

  let currentSessionKey = null; 
  let isOnDuty = false; // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
  function startDuty() {
    if (isOnDuty) {
      alert("‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }

    const startTime = new Date().toISOString();
    const logData = {
      officerId,
      name,
      rank,
      action: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà üö®",
      startTime: startTime
    };
    const ref = db.ref("roster-logs").push(logData);
    currentSessionKey = ref.key;
    isOnDuty = true;

    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° / ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£
    startBtn.disabled = true;
    endBtn.disabled = false;
  }

  // ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£
  function endDuty() {
    if (!isOnDuty || !currentSessionKey) {
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô");
      return;
    }

    const endTime = new Date().toISOString();
    db.ref("roster-logs/" + currentSessionKey).once("value", snapshot => {
      const data = snapshot.val();
      if (data && data.startTime) {
        const durationMs = new Date(endTime) - new Date(data.startTime);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°
        const hours = Math.floor(durationMs / 1000 / 60 / 60);
        const minutes = Math.floor((durationMs / 1000 / 60) % 60);
        const seconds = Math.floor((durationMs / 1000) % 60);

        const durationStr = `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;

        db.ref("roster-logs/" + currentSessionKey).update({
          action: "‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£ ‚úÖ",
          endTime: endTime,
          duration: durationStr
        });

        currentSessionKey = null;
        isOnDuty = false;

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° / ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£
        startBtn.disabled = false;
        endBtn.disabled = true;
      }
    });
  }

  // ‡πÅ‡∏™‡∏î‡∏á logs Realtime
  db.ref("roster-logs").on("child_added", snapshot => renderLog(snapshot));
  db.ref("roster-logs").on("child_changed", snapshot => renderLog(snapshot, true));

  function renderLog(snapshot, isUpdate = false) {
    const log = snapshot.val();
    const liId = "log-" + snapshot.key;
    let li = document.getElementById(liId);

    if (!li) {
      li = document.createElement("li");
      li.id = liId;
      logsEl.appendChild(li);
    }

    let text = `${log.rank} ${log.name} (${log.officerId}) ‚Üí ${log.action}`;
    if (log.startTime) {
      text += ` | ‡πÄ‡∏£‡∏¥‡πà‡∏°: ${new Date(log.startTime).toLocaleString("th-TH")}`;
    }
    if (log.endTime) {
      text += ` | ‡πÄ‡∏•‡∏¥‡∏Å: ${new Date(log.endTime).toLocaleString("th-TH")}`;
    }
    if (log.duration) {
      text += ` | ‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${log.duration}`;
    }

    li.textContent = text;
  }

  // Event ‡∏õ‡∏∏‡πà‡∏°
  startBtn.addEventListener("click", startDuty);
  endBtn.addEventListener("click", endDuty);
</script>
